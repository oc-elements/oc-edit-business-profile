<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">
<link rel="import" href="../oc-core-utils/oc-store.html">
<link rel="import" href="../oc-toast/oc-toast.html">
<link rel="import" href="../vaadin-upload/theme/lumo/vaadin-upload.html">
<link rel="import" href="../../src/oc-button-styles.html">

<dom-module id="oc-edit-business-profile">
    <template>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style include="shop-button shop-button oc-button-styles" is="custom-style">

            :host {
                display: block;
                background: #fff;
                color: #000;
            }

            .category-heading {
                border-top: 1px #cecece solid;
                border-bottom: 1px #cecece solid;
                background: #f8f8f8;
                color: #000;
            }

            h3 {
                font-size: 1.13em !important;
                margin: 10px 0 !important;
            }

        </style>

        <oc-organisation-api id="organisationApi"></oc-organisation-api>
        <oc-toast id="toast"></oc-toast>

        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-12">
                    <div class="row category-heading">
                        <div class="col-xs-12">
                            <h3>Business Profile</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <paper-input type="text" label="Company Name"
                                         value="{{_businessProfile.name}}"></paper-input>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            <paper-input label="Company Code" value="{{_businessProfile.code}}"></paper-input>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <paper-input type="tel" value="{{_businessProfile.profile.contactNumber}}"
                                         label="Contact Number"></paper-input>
                        </div>
                    </div>
                    <div class="row" hidden="[[!showFileUploader]]">
                        <div class="col-xs-12">
                            <label>Business Profile Picture</label>
                            <vaadin-upload id="fileUpload" on-upload-before="_uploadBefore" max-files="1">
                                <img src="[[_shopImageSrc]]" alt="[[item.title]]">
                            </vaadin-upload>
                        </div>
                    </div>

                </div>
            </div>
            <!--TODO: dom if you already have a business account -->
            <div class="row category-heading">
                <div class="col-xs-12 text-center">
                    <paper-button class="update-button primary-button" on-tap="_updateOrganisationDetails">
                        Save
                    </paper-button>
                </div>
            </div>
        </div>
    </template>

    <script>
		/**
		 * `oc-link-payment-account`
		 * Element to link payment accounts
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class OcEditBusinessProfile extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() {
				return 'oc-edit-business-profile';
			}

			static get properties() {
				return {
					_organisationId: {
						type: Number,
						statePath: 'organisation.id',
						observer: '_getOrganisation',
					},
					_loading: {
						type: Boolean,
						value: false,
						notify: true,
					},
					// A way to indicate to the parent this code is active or not. Its a bit cleaner than a listener
					isActive: {
						type: Boolean,
						value: false,
						notify: true,
					},
					// Show the file uploader or not. Primary purpose is for backward compatibility
					showFileUploader: {
						type: Boolean,
						value: false,
					},
				};
			}

			ready() {
				super.ready();
				this.addEventListener('file-received', (event) => {
					this._shopImage = event.detail;
				});
			}

			// Catch the file uploader event and store file in memory before pushing it to the backend
			_uploadBefore(event) {
				// cancel AJAX Request
				event.preventDefault();

				/*
				* We basically bypassing the default behaviour of the file uploader, to manually upload
				* the file to the server
				*/
				const file = event.detail.file;
				const fileIndex = this.$.fileUpload.files.indexOf(file);

				// Update UI to indicate file has been uploaded
				this.$.fileUpload.set(['files', fileIndex, 'progress'], 100);
				this.$.fileUpload.set(['files', fileIndex, 'complete'], true);
				this.$.fileUpload.set(['files', fileIndex, 'status'], 'Complete');
				this.$.fileUpload.set(['files', fileIndex, 'held'], false);

				// fire event
				const receiveEvent = new CustomEvent('file-received', {'detail': file});
				this.dispatchEvent(receiveEvent);
			}

			_getOrganisation() {
				this.$.organisationApi.getOrganisation(this._organisationId)
					.then(function(request) {
						this._businessProfile = request.response;
						this._billingProfile = request.response.billingProfile;
						// Static url where is image is saved. WIll most likely change in near future
						this._shopImageSrc = `https://test-static.ordercloud.com/${request.response.profile.imageThumb}`;
					}.bind(this));
			}

			getOrgData() {
				return {
					name: this._businessProfile.name,
					code: this._businessProfile.code,
					// types: this._businessProfile.types,
					// timezoneOffset: 2,
					// registeredDirectly: this._businessProfile.registeredDirectly,
					// industry: this._businessProfile.industries,
					organisationProfile: {
						contactPerson: this._businessProfile.profile.contactPerson,
						contactNumber: this._businessProfile.profile.contactNumber,
					},
					operatingHours: this._businessProfile.operatingHours,
					currencyCode: 'ZAR',
					billingProfile: this._businessProfile.billingProfile,
				};
			}

			_updateOrganisationDetails() {
				/* If there is a image upload. It will be uploaded on save then if
				* there is no errors organisation will be updated. */
				const imageUploadPromise = new Promise((resolve, reject) => {
					if (this._shopImage)
						this._uploadImage(resolve, reject);
					else
						resolve();
				});

				imageUploadPromise.then(() => {
					this.$.organisationApi.updateOrganisation(this._organisationId, this.getOrgData())
						.then((request) => {
							this._getOrganisation();
							this.$.toast.successStay('Business Profile Updated');
							this.isActive = false;

							// This will become a paramater as soon it is being used at different places
							this.dispatchEvent(new CustomEvent('change-page', {
								bubbles: true, composed: true, detail:
									{
										url: '/business-profile',
										data: {name: 'refresh', value: true},
									},
							}));
						})
						.catch((error) => {
							console.error(error.message);
						});
				});
			}

			// Build formdata object and upload image to the backend
			_uploadImage(resolve) {
				const file = new Blob([this._shopImage], {type: this._shopImage.type});

				const formData = new FormData();
				formData.append('image', file);
				this.$.organisationApi.uploadOrganisationImage(this._organisationId, formData)
					.then(() => {
						resolve();
					})
					.catch((error) => {
						console.error(error.message);
						this.$.toast.failed('Failed to upload image!: ' + error.message);
					});
			}
		}

		window.customElements.define(OcEditBusinessProfile.is, OcEditBusinessProfile);
    </script>
</dom-module>
