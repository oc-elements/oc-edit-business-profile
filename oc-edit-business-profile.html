<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../oc-organisation-api/oc-organisation-api.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../oc-core-utils/oc-store.html">
<link rel="import" href="../oc-leaflet-map/oc-leaflet-map.html">
<link rel="import" href="../oc-toast/oc-toast.html">
<link rel="import" href="../oc-geo-lookup/oc-geo-lookup.html">


<dom-module id="oc-edit-business-profile">
    <template>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style include="shop-button" is="custom-style">

            :host {
                display: block;
                background: #fff;
                color: #000;
            }

            .category-heading {
                border-top: 1px #cecece solid;
                border-bottom: 1px #cecece solid;
                background: #f8f8f8;
                color: #000;
            }

            h3 {
                font-size: 1.13em !important;
                margin: 10px 0 !important;
            }

            .update-button {
                background-color: #e0992f;
                width: 100%;
                height: 50px;
                margin: 10px 0;
            }

        </style>

        <oc-organisation-api id="organisationApi"></oc-organisation-api>
        <oc-geo-lookup id="geoLookup"></oc-geo-lookup>
        <oc-toast id="toast"></oc-toast>

        <div class="container-fluid">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="row category-heading">
                            <div class="col-xs-12">
                                <h3>Business Profile</h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input type="text" label="Company Name"
                                             value="{{_businessProfile.name}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input label="Company Code" value="{{_businessProfile.code}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input type="email" value="{{_businessProfile.notificationSourceEmail}}"
                                             label="Email"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="streetNumber" type="text" label="Street Number"
                                             value="{{_organisationAddress.streetNumber}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="streetName" type="text" label="Street Address"
                                             value="{{_organisationAddress.streetName}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="complex" type="text" label="Complex"
                                             value="{{_organisationAddress.complex}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="suburb" type="text" label="Suburb"
                                             value="{{_organisationAddress.suburb}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="city" type="text" label="City"
                                             value="{{_organisationAddress.city}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="postalCode" type="text" label="Postal Code"
                                             value="{{_organisationAddress.postalCode}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="province" type="text" label="Province"
                                             value="{{_organisationAddress.province}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <paper-input id="country" type="text" label="Country"
                                             value="{{_organisationAddress.country}}"></paper-input>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <oc-leaflet-map latitude="{{_lat}}" longitude="{{_lng}}"></oc-leaflet-map>
                            </div>
                        </div>

                    </div>
                </div>
            <!--TODO: dom if you already have a business account -->
            <div class="row category-heading">
                <div class="col-xs-12 text-center">
                    <paper-button raised on-tap="_onValidateAddress" class="update-button" hidden="[[_addressValid]]">
                        Validate Address
                    </paper-button>
                </div>
            </div>
            <div class="row category-heading">
                <div class="col-xs-12 text-center">
                    <paper-button class="update-button" on-tap="_updateOrganisationDetails" hidden="[[_addressValid]]">
                        Update Business Profile
                    </paper-button>
                </div>
            </div>
        </div>
    </template>

    <script>
		/**
		 * `oc-link-payment-account`
		 * Element to link payment accounts
		 *
		 * @customElement
		 * @polymer
		 * @demo demo/index.html
		 */
		class OcEditBusinessProfile extends Ordercloud.ReduxMixin(Polymer.Element) {
			static get is() {
				return 'oc-edit-business-profile';
			}

			static get properties() {
				return {
					_organisationId: {
						type: Number,
						statePath: 'organisation.id',
						observer: '_getOrganisation'
					},
					_loading: {
						type: Boolean,
						value: false,
						notify: true
					},
					_lat: {
						type: Number,
					},
					_lng: {
						type: Number,
					},
					_organisationAddress: {
						type: Object,
						value: {},
					},
					_addressValid: {
						type: Boolean,
						value: false
					},
				};
			}

			ready() {
				super.ready();
			}

			_onValidateAddress() {
				const street = this._organisationAddress.streetNumber + " " + this._organisationAddress.streetName;
				const suburb = this._organisationAddress.suburb;
				const city = this._organisationAddress.city;
				this.$.geoLookup.getLocation(street, suburb, city).then((request) => {
					const diplayPosition = request.response.Response.View[0].Result[0].Location.DisplayPosition;
				this._lat = diplayPosition.Latitude;
				this._lng = diplayPosition.Longitude;

				this.$.toast.successStay("Map pin set. Please adjust map pin if location is incorrect.")
			})
			}

			_getOrganisation(organisationId) {
				this._getOrganisationAddress();
				this.$.organisationApi.getOrganisation(organisationId)
					.then(function (request) {
						this._businessProfile = request.response;
						this._billingProfile = request.response.billingProfile;
					}.bind(this));
			}


			_updateOrganisationDetails() {
				// If Address exist update current one if not create one
				if (this._organisationAddress.id)
					this._updateOrganisationAddress();
				else
					this._createOrganisationAddress();

				let data = {};
				data.name = this._businessProfile.name;
				data.code = this._businessProfile.code;
				data.types = this._businessProfile.type;
				data.notificationSourceEmail = this._businessProfile.data;

				data.billingProfile = {};
				data.billingProfile.businessName = this._billingProfile.businessName;
				data.billingProfile.vatNumber = this._billingProfile.vatNumber;
				data.billingProfile.contactName = this._billingProfile.contactName;
				data.billingProfile.address = this._billingProfile.address;
				data.billingProfile.phoneNumber = this._billingProfile.phoneNumber;
				data.billingProfile.email = this._billingProfile.email;

				this.$.organisationApi.updateOrganisation(this._organisationId, data)
					.then((request) => {
					this.$.toast.successStay("Business Profile Updated");
			})
			}

			_getOrganisationAddress() {
				this.$.organisationApi.getAddress(this._organisationId)
					.then((request) => {
					this._organisationAddress = request.response;
				this._lat = request.response.latitude;
				this._lng = request.response.longitude;
			})
			}

			_updateOrganisationAddress() {
				this._organisationAddress.longitude = this._lng;
				this._organisationAddress.latitude = this._lat;
				// Remove id, should not be part of the update
				const addressObject = JSON.parse(JSON.stringify(this._organisationAddress));
				delete addressObject.id;
				this.$.organisationApi.updateAddress(this._organisationAddress.id, addressObject)
					.then(() => {
					this.$.toast.success("Business Address Updated!");
			}).catch((e) => {
					this.$.toast.failed("Failed To Update Business");
				console.error(e.message)
			})
			}

			_createOrganisationAddress() {
				this._organisationAddress.longitude = this._lng;
				this._organisationAddress.latitude = this._lat;
				this.$.organisationApi.createAddress(this._organisationId, this._organisationAddress)
					.then(() => {
				})
			}
		}

		window.customElements.define(OcEditBusinessProfile.is, OcEditBusinessProfile);
    </script>
</dom-module>
